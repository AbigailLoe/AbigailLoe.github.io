---
layout: default
title: "Explore Papers"
categories: papers
---
{% include JB/setup %}

<!-- Add d3 and d3-cloud libraries -->
<script src="https://d3js.org/d3.v7.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/d3-cloud@1.2.5/build/d3.layout.cloud.min.js"></script>

<div class="row">
    <div class="col-md-12">
        <div class="centered-pills">
            <ul class="nav nav-pills note-button">
                <li role="presentation">
                    <a class="off" href="/papers/">
                        <i class="fa fa-binoculars fa-fw"></i> Squares
                    </a>
                </li>
                <li role="presentation">
                    <a class="off" href="/papers/archive/year">
                        <i class="fa fa-calendar fa-fw"></i> Year
                    </a>
                </li>
                <li role="presentation">
                    <a class="off" href="/papers/archive/topic">
                        <i class="fa fa-podcast fa-fw"></i> Topic
                    </a>
                </li>
                <li role="presentation" class="active">
                    <a class="off" href="/papers/archive/explore">
                        <i class="fa fa-filter fa-fw"></i> Explore
                    </a>
                </li>
            </ul>
        </div>
    </div>
</div>

<b>Some papers are not listed below. See <a href="https://scholar.google.com/citations?user=3ffCNrEAAAAJ&hl=en" class="label label-primary">Google Scholar</a> for a more complete list.</b><br>

<!-- Add word cloud section -->
<div class="row">
    <div class="col-md-8">
        <div class="panel panel-default">
            <div class="panel-heading" style="display: flex; align-items: center; padding: 5px 15px;">
                <h3 class="panel-title" style="margin: 0;">Word Cloud</h3>
                <div id="paperCount" class="alert alert-info" style="display: inline-block; margin: 0 0 0 10px; padding: 2px 3px;">Showing all papers ({{ site.categories.papers | size }} entries)</div>
            </div>
            <div class="panel-body">
                <div id="filterCriteria" class="alert alert-warning" style="display: none;">
                </div>
                <div id="wordcloud" style="width: 100%; height: 400px;"></div>
            </div>
        </div>
        <!-- Add Timeline Panel -->
        <div class="panel panel-default">
            <div class="panel-heading">
                <h3 class="panel-title">Publication Timeline</h3>
            </div>
            <div class="panel-body">
                <div id="timeline" style="width: 100%; height: 150px;"></div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="panel panel-default filter-panel">
            <div class="panel-body">
                <div class="form-group filter-group">
                    <label for="yearFilter"><i class="fa fa-calendar"></i> Year <small class="text-muted">(Select one or more years)</small></label>
                    <select class="form-control filter-select" id="yearFilter" multiple>
                        {% assign years = site.categories.papers | map: 'year' | uniq %}
                        {% assign numeric_years = years | where_exp: "year", "year != 'submitted'" | sort | reverse %}
                        {% assign submitted_years = years | where_exp: "year", "year == 'submitted'" %}
                        {% for year in submitted_years %}
                        <option value="{{ year }}">{{ year }}</option>
                        {% endfor %}
                        {% for year in numeric_years %}
                        <option value="{{ year }}">{{ year }}</option>
                        {% endfor %}
                    </select>
                    <button class="clear-filter" data-filter="yearFilter"><i class="fa fa-times"></i> Clear</button>
                </div>
                <div class="form-group filter-group">
                    <label for="typeFilter"><i class="fa fa-tag"></i> Type <small class="text-muted">(Select one or more types)</small></label>
                    <select class="form-control filter-select" id="typeFilter" multiple>
                        <option value="statistical">Statistical</option>
                        <option value="substantive">Substantive</option>
                    </select>
                    <button class="clear-filter" data-filter="typeFilter"><i class="fa fa-times"></i> Clear</button>
                </div>
                <div class="form-group filter-group">
                    <label for="journalFilter"><i class="fa fa-book"></i> Venue <small class="text-muted">(Select one or more venues)</small></label>
                    <select class="form-control filter-select" id="journalFilter" multiple>
                        {% assign journals = site.categories.papers | map: 'journal' | compact | uniq | sort %}
                        {% for journal in journals %}
                        <option value="{{ journal }}">{{ journal }}</option>
                        {% endfor %}
                    </select>
                    <button class="clear-filter" data-filter="journalFilter"><i class="fa fa-times"></i> Clear</button>
                </div>
                <div class="form-group">
                    <button id="resetFilters" class="btn btn-default btn-block reset-button">
                        <i class="fa fa-refresh"></i> Reset All
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>



<div id="papersList">
    {% for paper in site.categories.papers %}
    <div class="paper-item" 
         data-year="{{ paper.year }}"
         data-journal="{{ paper.journal | default: '' }}"
         data-type="{% if paper.type %}{{ paper.type }}{% else %}substantive{% endif %}"
         data-authors="{{ paper.authors }}">
        <div class="paper-title">
            <span class="paper-number"></span><a href="{{ paper.url }}" class="off" style="font-family: Arial">{{ paper.title }}</a>
        </div>
        <div class="paper-authors">
            {% assign authorsq = paper.authors | split: ', ' %}
            {% for author_iter in authorsq %}
            {% if forloop.last %}
                {% assign in_file = false %}
                {% assign in_file_web = false %}
                {% for person in site.categories.team %}
                    {% if author_iter contains person.title %}
                        {% assign in_file = true %}
                        {% assign in_file_web = person.web %}
                    {% endif %}
                {% endfor %}
                
                {% if in_file %}
                    <a href="http://{{ in_file_web }}">{{ author_iter }}</a> ({{ paper.year }}).
                {% else %}
                    {{ author_iter }} ({{paper.year}}).
                {% endif %}
            {% else %}
                {% assign in_file = false %}
                {% assign in_file_web = false %}
                {% for person in site.categories.team %}
                    {% if author_iter contains person.title %}
                        {% assign in_file = true %}
                        {% assign in_file_web = person.web %}
                    {% endif %}
                {% endfor %}
            
                {% if in_file %}
                    <a href="http://{{ in_file_web }}">{{ author_iter }}</a>,
                {% else %}
                    {{ author_iter }},
                {% endif %}
            {% endif %}
            {% endfor %}
        </div>
        <div class="paper-links">
            {% if paper.journal %}<span class="paper-journal">â–º <em>{{ paper.journal }}</em></span>{% endif %}
            {%if paper.external_link%}<a href="{{ paper.external_link}}" class="label label-info">[paper link]</a>{% endif %}
            {%if paper.github%}<a href="{{ paper.github }}" class="label label-red">[code]</a>{% endif %}
            {%if paper.doi%}<a href="http://dx.doi.org/{{ paper.doi }}" class="label label-default">[doi]</a>{% endif %}
            {%if paper.pdf%}<a href="{{ paper.pdf }}" class="label label-primary">[pdf]</a>{% endif %}
            {%if paper.poster%}<a href="{{ paper.poster }}" class="label label-green">[poster]</a>{% endif %}
            {%if paper.supplement%}<a href="{{ paper.supplement }}" class="label label-primary">[supplement]</a>{% endif %}
            {%if paper.slides%}<a href="{{ paper.slides }}" class="label label-purple">[slides]</a>{% endif %}
        </div>
    </div>
    {% endfor %}
</div>

<style>
.paper-item {
    margin-bottom: 4px;
    padding: 8px;
    border-radius: 5px;
    transition: all 0.3s ease;
}

.alert-info {
    padding: 2px 3px;
    margin-bottom: 2px;
}

.alert-warning {
    padding: 2px 3px;
    margin-bottom: 2px;
}

.paper-item:hover {
    background-color: #f8f9fa;
}

.paper-title {
    font-size: 1.1em;
    margin-bottom: 2px;
}

.paper-authors {
    margin-bottom: 2px;
}

.paper-links {
    margin-top: 2px;
}

.paper-journal {
    margin-right: 10px;
}

.hidden {
    display: none;
}

#paperCount {
    margin-bottom: 15px;
}

.filter-col {
    padding-right: 5px;
    padding-left: 5px;
}

.filter-col .form-control {
    width: 100%;
    min-width: 120px;
}

.filter-group {
    position: relative;
    margin-bottom: 10px;
}

.filter-group label {
    display: block;
    margin-bottom: 4px;
    color: #495057;
    font-weight: 500;
    font-size: 0.95em;
}

.filter-group label i {
    margin-right: 5px;
    color: #6c757d;
}

.filter-select {
    width: 100%;
    padding: 4px 8px;
    border: 1px solid #ced4da;
    border-radius: 4px;
    background-color: #fff;
    transition: all 0.2s ease;
    max-height: 200px;
}

.filter-select:hover {
    border-color: #adb5bd;
}

.filter-select:focus {
    border-color: #80bdff;
    box-shadow: 0 0 0 0.2rem rgba(0,123,255,0.25);
}

.clear-filter {
    position: absolute;
    right: 0;
    top: 0;
    padding: 2px 6px;
    font-size: 11px;
    background-color: #dc3545 !important;  /* Bootstrap danger color */
    border: 1px solid #dc3545 !important;
    border-radius: 3px;
    cursor: pointer;
    display: none;
    color: white !important;
    transition: all 0.2s ease;
    font-weight: 500;
    text-decoration: none;
}

.clear-filter:hover {
    background-color: #c82333 !important;  /* Darker red on hover */
    border-color: #bd2130 !important;
    color: white !important;
    text-decoration: none;
}

.clear-filter i {
    margin-right: 3px;
    font-size: 10px;
}

.filter-group.has-selection .clear-filter {
    display: block;
}

.reset-button {
    padding: 8px 12px;
    background-color: #f8f9fa;
    border: 1px solid #dee2e6;
    color: #495057;
    transition: all 0.2s ease;
}

.reset-button:hover {
    background-color: #e9ecef;
    border-color: #ced4da;
    color: #212529;
}

.reset-button i {
    margin-right: 5px;
}

/* Style for multiple select options */
.filter-select option {
    padding: 2px 4px;
    margin: 0;
    border-radius: 2px;
    font-size: 0.95em;
    line-height: 1.4;
}

.filter-select option:checked {
    background-color: #e9ecef;
    color: #495057;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .filter-col {
        margin-bottom: 15px;
    }
    
    .filter-panel .panel-body {
        padding: 15px;
    }
}

#wordcloud {
    text-align: center;
    position: relative;
}

.word {
    cursor: pointer;
    transition: all 0.3s ease;
}

.word:hover {
    fill: #007bff;
}

.wordcloud-loading {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(255, 255, 255, 0.9);
    padding: 20px;
    border-radius: 5px;
    box-shadow: 0 0 10px rgba(0,0,0,0.1);
    display: none;
}

.wordcloud-loading.active {
    display: block;
}

.filter-panel {
    margin-top: 0px;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.filter-panel .panel-heading {
    background-color: #f8f9fa;
    border-bottom: 1px solid #e9ecef;  /* Reduced border thickness */
    padding: 8px 15px;  /* Reduced padding */
    min-height: auto;  /* Remove minimum height */
}

.filter-panel .panel-title {
    font-size: 1.1em;  /* Slightly smaller font */
    color: #495057;
    margin: 0;
    line-height: 1.2;  /* Tighter line height */
}

.filter-panel .panel-title i {
    margin-right: 6px;  /* Reduced margin */
    color: #6c757d;
    font-size: 0.95em;  /* Slightly smaller icon */
}

.filter-panel .panel-body {
    padding: 15px;
}

.filter-col {
    padding: 0 8px;
}

/* Make the select box more compact */
.filter-group {
    position: relative;
    margin-bottom: 10px;
}

.filter-group label {
    display: block;
    margin-bottom: 4px;
    color: #495057;
    font-weight: 500;
    font-size: 0.95em;
}

/* Adjust the clear button position */
.clear-filter {
    position: absolute;
    right: 0;
    top: 0;
    padding: 2px 6px;
    font-size: 11px;
    background-color: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 3px;
    cursor: pointer;
    display: none;
    color: #6c757d;
    transition: all 0.2s ease;
}

/* Adjust panel padding */
.filter-panel .panel-body {
    padding: 15px;
}

.filter-col {
    padding: 0 8px;
}

.filter-panel {
    margin-bottom: 10px;
}

.filter-panel .panel-body {
    padding: 10px;
}

.filter-group {
    margin-bottom: 5px;
}

.filter-select {
    margin-bottom: 5px;
}

.clear-btn {
    margin: 5px 0;
}

/* Add margin control for word cloud panel */
.panel-default {
    margin-bottom: 10px;
}

/* Override for word cloud panel to reduce gap */
.panel-default:has(#wordcloud) {
    margin-bottom: 5px;
}

.alert-info {
    padding: 5px 15px;
    margin-bottom: 2px;
}

.centered-pills {
    margin-top: -15px;
    margin-bottom: 5px;
}
.centered-pills .nav-pills {
    display: inline-block;
}
.centered-pills .nav-pills > li {
    margin: 0 2px;
}
.centered-pills .nav-pills > li > a {
    padding: 5px 10px;
    font-size: 0.9em;
}

/* Timeline styles */
.timeline-bar {
    fill: #007bff;
    transition: fill 0.3s ease;
}

.timeline-bar:hover {
    fill: #0056b3;
}

.timeline-axis path,
.timeline-axis line {
    stroke: #ccc;
}

.timeline-axis text {
    font-size: 12px;
    fill: #666;
}

.timeline-tooltip {
    position: absolute;
    padding: 10px;
    background: rgba(255, 255, 255, 0.95);
    border: 1px solid #ddd;
    border-radius: 4px;
    pointer-events: none;
    font-size: 12px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    z-index: 1000;
    max-width: 300px;
}

.timeline-tooltip h4 {
    margin: 0 0 5px 0;
    font-size: 14px;
    font-weight: bold;
    color: #333;
}

.timeline-tooltip p {
    margin: 0 0 5px 0;
    color: #666;
}

.timeline-tooltip ul {
    margin: 0;
    padding-left: 20px;
}

.timeline-tooltip li {
    margin: 2px 0;
    color: #444;
}

.timeline-tooltip a {
    color: #007bff;
    text-decoration: none;
}

.timeline-tooltip a:hover {
    text-decoration: underline;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const yearFilter = document.getElementById('yearFilter');
    const journalFilter = document.getElementById('journalFilter');
    const typeFilter = document.getElementById('typeFilter');
    const resetButton = document.getElementById('resetFilters');
    const paperItems = document.querySelectorAll('.paper-item');
    const paperCount = document.getElementById('paperCount');
    const filterCriteria = document.getElementById('filterCriteria');
    const totalPapers = paperItems.length;

    // Add word cloud container
    const wordcloudContainer = d3.select('#wordcloud');
    let currentLayout = null;

    function updateFilterGroups() {
        document.querySelectorAll('.filter-group').forEach(group => {
            const select = group.querySelector('select');
            if (select.selectedOptions.length > 0) {
                group.classList.add('has-selection');
            } else {
                group.classList.remove('has-selection');
            }
        });
    }

    function clearFilter(filterId) {
        const filter = document.getElementById(filterId);
        filter.selectedIndex = -1;
        applyFilters();
    }

    // Add click handlers for clear buttons
    document.querySelectorAll('.clear-filter').forEach(button => {
        button.addEventListener('click', function() {
            const filterId = this.dataset.filter;
            clearFilter(filterId);
        });
    });

    function updateFilterCriteria() {
        const selectedYears = Array.from(yearFilter.selectedOptions).map(option => option.value);
        const selectedJournals = Array.from(journalFilter.selectedOptions).map(option => option.value);
        const selectedTypes = Array.from(typeFilter.selectedOptions).map(option => option.value);

        let criteriaText = [];
        
        if (selectedYears.length > 0) {
            criteriaText.push(`Year: ${selectedYears.join(', ')}`);
        }
        if (selectedJournals.length > 0) {
            criteriaText.push(`Venue: ${selectedJournals.join(', ')}`);
        }
        if (selectedTypes.length > 0) {
            criteriaText.push(`Type: ${selectedTypes.join(', ')}`);
        }

        if (criteriaText.length > 0) {
            filterCriteria.innerHTML = `<strong>Filter Criteria:</strong> ${criteriaText.join(' | ')}`;
            filterCriteria.style.display = 'block';
        } else {
            filterCriteria.style.display = 'none';
        }
    }

    function updatePaperCount() {
        const visiblePapers = document.querySelectorAll('.paper-item:not(.hidden)').length;
        if (visiblePapers === totalPapers) {
            paperCount.textContent = `Showing all papers (${totalPapers} entries)`;
        } else {
            paperCount.textContent = `Showing ${visiblePapers} of ${totalPapers} papers`;
        }
    }

    function updateNumbering() {
        let visibleCount = 0;
        paperItems.forEach(item => {
            if (!item.classList.contains('hidden')) {
                visibleCount++;
                const numberSpan = item.querySelector('.paper-number');
                numberSpan.textContent = `${visibleCount}. `;
            } else {
                const numberSpan = item.querySelector('.paper-number');
                numberSpan.textContent = '';
            }
        });
    }

    function generateWordCloud() {
        // Show loading indicator
        wordcloudContainer.selectAll('*').remove();
        const loadingDiv = wordcloudContainer
            .append('div')
            .attr('class', 'wordcloud-loading active')
            .text('Updating word cloud...');

        // Get visible papers
        const visiblePapers = document.querySelectorAll('.paper-item:not(.hidden)');
        let text = '';
        
        // Create an array of promises for fetching paper content
        const paperPromises = Array.from(visiblePapers).map(paper => {
            // Get title
            const title = paper.querySelector('.paper-title').textContent;
            let paperText = title + ' ';

            // Get paper URL and fetch content
            const paperLink = paper.querySelector('.paper-title a').href;
            return fetch(paperLink)
                .then(response => response.text())
                .then(html => {
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    
                    // Get abstract if available - improved extraction
                    let paperText = title + ' ';
                    
                    // Try different ways to find the abstract
                    const abstractHeading = Array.from(doc.querySelectorAll('strong, h1, h2, h3, h4, h5, h6'))
                        .find(el => el.textContent.toLowerCase().includes('abstract'));
                    
                    if (abstractHeading) {
                        // Get the next element that contains the abstract text
                        let currentNode = abstractHeading.nextElementSibling;
                        while (currentNode && 
                               !(currentNode.tagName && 
                                 currentNode.tagName.match(/^H[1-6]$/) && 
                                 !currentNode.textContent.toLowerCase().includes('abstract'))) {
                            paperText += currentNode.textContent + ' ';
                            currentNode = currentNode.nextElementSibling;
                        }
                    }
                    
                    // Get keywords if available
                    const keywordsHeading = Array.from(doc.querySelectorAll('strong, h1, h2, h3, h4, h5, h6'))
                        .find(el => el.textContent.toLowerCase().includes('keywords'));
                    
                    if (keywordsHeading && keywordsHeading.nextElementSibling) {
                        paperText += keywordsHeading.nextElementSibling.textContent + ' ';
                    }
                    
                    return paperText;
                })
                .catch(error => {
                    console.error('Error fetching paper content:', error);
                    return paperText; // Return just the title if fetch fails
                });
        });

        // Wait for all paper content to be fetched
        Promise.all(paperPromises)
            .then(paperTexts => {
                // Combine all paper texts
                text = paperTexts.join(' ');

                // Common words to exclude
                const stopWords = new Set([
                    // check this website: https://gist.github.com/sebleier/554280
                    'ups', 'ninety', 'biol', 'don', 'exactly', 'everything', 'pj', 'go', 'se', "that's", 'please', 'ci', 'downwards', 'mu', 'to', 'po', 'thousand', 'needn', 'a1', 'sometimes', 'pf', 'dy', 'los', 'themselves', 'fj', 'sufficiently', 'tries', 'come', 'because', 'ix', 's', 'against', 'c3', 'sj', 'research', 'provides', 'about', "shan't", 'sp', 'tq', 'rf', 'fifteen', 'tf', 'cm', 'date', "they've", 'kg', 'according', 'everywhere', 'still', 'th', 'ti', 'somewhere', "they'll", 'just', 'owing', 'affected', 'quickly', 'ui', 'latterly', 'pc', 'poorly', 'words', 'been', 'potentially', 'oj', "how's", 'pr', 'therein', 'yj', 'ok', 'nl', 'into', 'ibid', 'anybody', 'rn', 'within', 'affecting', 'ar', 'lj', "c's", 'nearly', 'causes', 'greetings', 'using', 'yl', 'sa', 'u201d', 'me', 'mightn', 'viz', 'tj', "we've", 'above', 'even', 'et-al', 'gets', 'oa', 'pagecount', 'eu', 'particular', 'added', 'everybody', 'mo', 'pq', 'sf', 'ue', 'us', 'i4', 'ro', 'immediate', 'pas', 'beside', 'iz', 'ny', 'theyre', 'z', 'have', 'appreciate', 'shown', 'line', 'ra', "mightn't", 'very', "you'd", 'anyone', 'nevertheless', 'can', 'isn', 'usefulness', 'eo', 'f', 'several', 'apart', 'none', 'az', 'another', 'here', 'ox', 'although', 'happens', 'see', 'hy', 'only', 'does', 'vq', 'il', 'shall', "should've", 'stop', "what'll", 'et', 'edu', 'shouldn', 'iy', 'nc', 'from', 'hs', 'ps', 'le', 'example', 'hadn', 'du', 'a3', 'formerly', 'four', 'lately', 'rm', 'keep', 'reasonably', 'thered', 'vd', 'rc', 'thru', 'b3', 'able', 'how', 'ignored', 'p2', 'find', 'hither', 'should', 'him', 'least', 'fc', 'n2', 'gives', 'b1', 'g', 'might', 'say', 'under', 'uses', "there's", 'out', 'taking', 'tried', 'willing', 'better', 'ex', 'up', 'saying', 'mean', 'heres', 'miss', 'proud', 'overall', 'same', 'obtain', 'got', 'qv', "what's", 'my', 'asking', 'fa', 'par', 'recently', "shouldn't", 'right', 'somewhat', 'thereafter', "they'd", "who's", 'i', 'someone', 'cs', 'front', 'nonetheless', 'around', 'gone', 'million', 'new', 'ot', 'va', 'being', 'dp', 'ad', 'run', 'thanx', "that'll", 'oh', 'bi', 'past', 'al', 'strongly', 'p1', 'ft', 'whats', "it's", 'second', 'inner', 'thanks', 'interest', 'related', 'er', "wasn't", 'ip', 'many', 'ff', 'yt', 't', 'best', 'tx', 'much', 'between', 'possibly', 'available', 'empty', 'found', 'les', 'lets', 'oq', 'qu', 'es', 'fifth', 'lr', 'didn', 'pages', 'q', 're', 'her', 'seriously', 't2', 'wasn', 'whatever', 'make', 'your', "there'll", 'om', 'indicated', 'tr', 'fi', 'three', 'vu', 'described', 'made', "here's", 'rv', 'anyways', 'anywhere', 'ch', 'usually', 'y', 'successfully', 'ought', 'ss', 'ph', 'c1', 'i2', 'xs', 'll', 'indeed', 'gr', 'thence', 'side', 'shes', 'w', 'last', 'believe', 'aj', 'for', 'indicates', 'ba', 'i8', 'move', 'thoroughly', 'went', 'i7', 'lest', 'often', 'obviously', 'xj', "i'm", 'give', 'specify', 'eight', 't1', 'doesn', 'uk', 'sure', 'were', "don't", 'when', 'wherein', 'rd', 'substantially', 'zero', 'as', 'take', 'tn', 'getting', 'seven', 'youre', 'm', 'makes', 'h2', 'off', 'recent', 'af', 'fr', "wouldn't", 'put', 'que', 'r2', 'awfully', 'd', 'od', 'lc', 'again', 'est', 'hasn', 'during', 'nn', 'hardly', 'cv', 'having', 'latter', 'whereafter', 'xt', 'amount', 'every', 'km', 'dc', 'nor', 'possible', 'useful', "we'll", 'seem', 'forth', 'ri', "she'll", 'truly', 'where', 'become', 'twenty', "we're", 'st', 'behind', 'rr', 'l2', 'n', 'p', 'page', 'tp', 'ls', 'x2', 'either', 'fs', 'hereupon', 'i3', 'lt', 'likely', 'ii', 'mustn', 'ru', 'ni', 'than', 'particularly', 'co', 'sub', 'doing', 'im', 'beginning', 'wish', 'throug', 'xf', 'av', 'h', "doesn't", 'zi', 'showed', "hadn't", 'relatively', 'there', 'little', 'sup', 'could', 'them', 'effect', 'de', 'hence', 'nothing', 'yes', 'wants', '3a', 'somethan', 'bl', 'needs', 'already', 'inc', 'sent', 'anyhow', 'ry', 'those', 'theres', 'x1', 'followed', 'id', 'inasmuch', 'begins', 'onto', 'h3', 'and', 'py', 'ow', 'both', 'lb', 'via', 'lo', 'mrs', 'ln', 'arise', 'e2', 'hasnt', 'ah', 'kj', 'moreover', 'meantime', 'wa', 'xo', 'wi', 'selves', "there've", 'you', 'nobody', 'novel', 'couldnt', 'also', 'oz', 'ref', 'so', 'world', 'cry', 'outside', 'done', 'hopefully', 'whose', 'further', 'non', "he'll", 'whither', 'most', 'ns', 'rather', 'act', 'afterwards', 'seemed', 'ea', 'top', 'contains', 'concerning', 'consider', 'previously', 'ol', 'sixty', 'fill', 'ord', 'information', 'con', 'gotten', 'sl', 'know', 'thank', 'cu', 'six', 'former', 'wheres', 'following', 'begin', 'j', 'mostly', 'an', 'elsewhere', 'somehow', 'c2', 'value', 'dk', '6o', 'couldn', 'howbeit', 'later', 'whether', 'below', 'u', 'without', 'actually', 'regards', 'tb', 'beyond', 'insofar', "i'll", 'jt', 'may', 'ag', 'course', 'always', 'ec', 'nos', 'different', 'going', 'herein', 'gy', 'hh', 'dj', 'these', 'whereas', 'zz', 'f2', 'allow', 'corresponding', 'detail', 'bn', 'ap', "couldn't", 'everyone', 'sr', 'briefly', 'presumably', 'whos', 'yr', 'fl', 'tt', 'full', 'old', 'gi', 'pt', 'op', 'hes', 'sq', 'system', 'eleven', 'cit', 'ko', 'ds', 'weren', 'among', 'werent', 'entirely', "you're", 'shed', 'http', 'clearly', 'due', 'fify', 'fire', 'she', 'bx', 'nr', 'consequently', 'won', 'tends', 'had', 'thereupon', 'ef', 'look', 'obtained', 'beginnings', 'placed', 'si', 'ur', 'e3', 'with', 'known', 'furthermore', 'anymore', 'pn', 'yet', "who'll", 'cz', 'amoungst', 'wed', 'iv', 'describe', 'accordingly', 'ms', 'sz', 'tip', 'okay', 'says', 'together', 'wo', 'becomes', 'whereby', 'used', 'means', 'wont', 'b2', 'are', 'fn', "ain't", 'came', 'mine', 'never', 'oi', 'get', 'vols', 'follows', "when's", 'of', 'necessary', 'otherwise', 'thin', 'ig', 'over', 'aren', 'liked', 'they', 'xx', 'regardless', "we'd", 'noted', 'seeming', 'og', 'xn', "needn't", 'back', 'ten', 'amongst', 'x', 'five', 'thickv', 'bill', 'normally', 'really', 'os', 'showns', 'indicate', 'bu', 'merely', 'nj', 'pm', 'our', 'per', 'sincere', 'way', 'section', 'anyway', 'his', 'mn', 'td', 'show', 'be', 'call', 'cy', 'specifying', "haven't", 'mug', 'whenever', 'specified', 'once', 'theyd', 'i6', 'ones', 'did', 'containing', 'others', 'fu', 'though', 'was', 'yours', 'ut', 'o', 'what', 'promptly', 'ts', 'maybe', 'except', 'sc', 'something', 'two', 'seeing', 'trying', 'less', 'became', 'becoming', 'hundred', 'au', 'since', 'such', 'whomever', 'similarly', 'taken', '0s', 'whence', 'do', 'bd', 'em', 'js', 'ours', 'across', 'few', 'next', 'ia', "she's", 'we', 'on', "won't", 'until', 'is', 'inward', 'ltd', "it'd", 'ca', 'perhaps', 'ax', 'ib', 'else', 'jj', 'meanwhile', 'no', 'pp', 'sy', 'various', 'must', 'aside', 'considering', 'bj', "isn't", 'ourselves', 'ever', 'widely', 'who', 'x3', 'hj', 'ain', 't3', 'bc', 'now', 'vt', 'df', 'ay', 'ei', 'think', 'iq', 'ab', 'besides', 'un', 'changes', 'neither', 'or', 'thou', 'appropriate', 'uo', 'thereto', 'gs', 'a4', 'ep', 'would', 'cd', 'thus', 'if', "where's", 'vs', 'immediately', 'towards', 'ne', 'ev', 'ask', 'ir', 'lf', 'volumtype', 'its', "weren't", 'y2', 'thereof', 'himself', 'own', 'sensible', 'rt', 'cannot', 'k', 'kept', 'gave', 'each', 'hu', 'necessarily', 'regarding', 'cant', 'first', 'need', 'unlikely', 'therefore', 'whereupon', 'dr', 'invention', 'pu', "you'll", 'given', 'quite', '0o', 'tv', 'seems', 'usefully', 'herself', 'importance', 'hereafter', 'wasnt', 'di', 'try', 'noone', 'specifically', 'goes', 'hers', 'bk', 'third', 'whoever', 'announce', 'cx', 'sd', 'am', 'certainly', 'ed', 'ob', 'similar', "a's", 'til', 'tell', 'mt', "c'mon", "she'd", 'ej', "i'd", 'hello', 'nine', 'ng', 'ce', 'not', 'cq', 'p3', 'sec', 'sn', 'tm', 'instead', 'gl', 'da', 'namely', 'ee', 'ma', 'rq', 'serious', 'v', 'xv', 'primarily', 'which', 'down', 'anything', 'gj', 'la', 'qj', 'took', 'ys', 'nowhere', 'te', 'wouldn', 'hi', 'keeps', 'yourselves', 'eq', 'bt', 'want', 'any', 'present', 'a2', 'etc', 'whod', 'vj', 'r', 'he', 'dd', "he'd", 'rh', 'ie', 'seen', 'all', 's2', 'some', 'tc', 'use', 'this', 'in', 'certain', 'e', "you've", 'fy', 'apparently', 'unfortunately', "he's", 'mill', 'more', 'cp', 'especially', 'along', 'ju', 'then', 'contain', 'home', 'suggest', 'ct', 'xi', 'a', 'however', 'ho', 'thats', 'said', 'ml', 'ran', 'ae', 'oc', 'cc', 'abst', 'like', 'approximately', 'itd', 'sm', 'ac', 'one', 'pe', "they're", 'self', 'whim', 'fo', 'despite', 'ke', 'twice', 'ge', 'readily', 'plus', 'well-b', 'mg', 'nay', 'b', 'rj', 'somebody', 'enough', 'near', 'cn', 'upon', 'adj', 'well', 'end', 'cj', 'refs', 'through', 'will', 'wonder', 'looks', 'ao', 'thorough', "it'll", 'hereby', 'l', 'shan', 'theirs', 'thereby', 'pi', 'bp', 'ga', 'help', 'cause', 'dl', 'ending', 'soon', 'youd', 'mainly', 'throughout', 'alone', 'beforehand', 'sorry', 'their', 'resulted', 'br', 'xk', "i've", 'respectively', 've', "can't", 'probably', 'definitely', 'comes', 'while', 'toward', 'ey', 'other', 'but', 'important', 'dt', 'let', 'pd', 'io', 'hid', 'rl', 'wouldnt', 'twelve', 'fix', 'nd', 'part', 'm2', 'ij', 'com', 'resulting', 'oo', 'hr', "why's", 'brief', 'currently', 'ih', 'bs', 'mr', 'significantly', 'welcome', '3b', 'cg', '6b', "that've", 'd2', 'slightly', 'thoughh', 'that', 'arent', 'affects', 'en', 'nt', 'ou', 'haven', 'therere', "let's", "aren't", 'results', 'eg', 'appear', 'accordance', 'unlike', 'whole', 'bottom', 'cf', 'na', 'largely', 'whom', 'allows', 'name', 'far', 'myself', 'rs', 'too', 'almost', 'at', "didn't", 'itself', 'research-articl', 'xl', 'after', 'jr', 'www', "mustn't", '3d', 'tl', 'el', 'shows', 'yourself', 'omitted', "hasn't", 'the', 'c', 'cr', 'looking', 'vol', 'cl', 'giving', 'unless', 'ic', 'dx', 'significant', 'index', 'why', 'knows', 'pl', 'away', 'auth', 'eighty', 'has', 'sometime', 'it', 'associated', 'aw', 'wherever', 'hed', 'forty', "t's", 'unto', 'um', 'secondly', 'uj', 'before', 'by', 'saw', 'pk', 'predominantly', 'vo',
                    'versus','year','years','high','low','most','least',
                    // Add common academic terms to exclude
                    'paper', 'study', 'research','abstract','methods','models','keywords','proposed',
                    'new','used','existing','demonstrate',
                    'collected','response','propose',
                     'analysis', 'method', 'approach', 'result', 'conclusion', 'finding', 'data', 'model', 'system', 'process', 'development', 'application', 'implementation', 'evaluation', 'assessment', 'review', 'survey', 'investigation', 'examination', 'exploration', 'discussion', 'consideration', 'perspective', 'framework', 'theory', 'practice', 'case', 'example', 'instance', 'aspect', 'factor', 'element', 'component', 'feature', 'characteristic', 'property', 'attribute', 'quality', 'nature', 'form', 'type', 'kind', 'category', 'class', 'group', 'set', 'collection', 'series', 'sequence', 'order', 'arrangement', 'structure', 'organization', 'pattern', 'design', 'plan', 'scheme', 'strategy', 'tactic', 'technique', 'procedure', 'protocol', 'guideline', 'principle', 'rule', 'law', 'regulation', 'policy', 'standard', 'criterion', 'measure', 'metric', 'indicator', 'parameter', 'variable', 'constant', 'coefficient', 'ratio', 'proportion', 'percentage', 'fraction', 'portion', 'part', 'section', 'segment', 'division', 'unit', 'module', 'block', 'piece', 'item', 'object', 'entity', 'unit', 'entity', 'object', 'item', 'piece', 'block', 'module', 'unit', 'division', 'segment', 'section', 'part', 'portion', 'fraction', 'percentage', 'proportion', 'ratio', 'coefficient', 'constant', 'variable', 'parameter', 'indicator', 'metric', 'measure', 'criterion', 'standard', 'policy', 'regulation', 'law', 'rule', 'principle', 'guideline', 'protocol', 'procedure', 'technique', 'tactic', 'strategy', 'scheme', 'plan', 'design', 'pattern', 'organization', 'structure', 'arrangement', 'order', 'sequence', 'series', 'collection', 'set', 'group', 'class', 'category', 'kind', 'type', 'form', 'nature', 'quality', 'attribute', 'property', 'characteristic', 'feature', 'component', 'element', 'factor', 'aspect', 'instance', 'example', 'case', 'practice', 'theory', 'framework', 'perspective', 'consideration', 'discussion', 'exploration', 'examination', 'investigation', 'survey', 'review', 'assessment', 'evaluation', 'implementation', 'application', 'development', 'process', 'system', 'model', 'data', 'finding', 'conclusion', 'result', 'approach', 'method', 'analysis', 'research', 'study', 'paper'
                ]);

                // Process text and count word frequencies
                const words = text.toLowerCase()
                    .replace(/[.,\/#!$%\^&\*;:{}=\_`~()]/g, '')  // Remove punctuation but keep hyphens
                    .replace(/\s+/g, ' ')
                    .trim()
                    .split(/\s+/)
                    .filter(word => word.length > 2 && !stopWords.has(word) && !/\d/.test(word));

                // Function to convert word to singular form
                function toSingular(word) {
                    // Clean up the word first
                    word = word.trim().toLowerCase();
                    
                    // Handle possessive forms first
                    if (word.includes("'s")) {
                        const base = word.replace("'s", "");
                        // Check if the base is an irregular plural
                        if (irregulars[base]) {
                            return irregulars[base];
                        }
                        return base;
                    }
                    if (word.includes("s'")) {
                        const base = word.replace("s'", "");
                        // Check if the base is an irregular plural
                        if (irregulars[base]) {
                            return irregulars[base];
                        }
                        return base;
                    }
                    if (word.endsWith("'")) {
                        const base = word.slice(0, -1);
                        // Check if the base is an irregular plural
                        if (irregulars[base]) {
                            return irregulars[base];
                        }
                        return base;
                    }

                    

                    // Common irregular plurals
                    const irregulars = {
                        'children': 'child',
                        'people': 'person',
                        'men': 'man',
                        'women': 'woman',
                        'mice': 'mouse',
                        'geese': 'goose',
                        'teeth': 'tooth',
                        'feet': 'foot',
                        'knives': 'knife',
                        'leaves': 'leaf',
                        'lives': 'life',
                        'wives': 'wife',
                        'wolves': 'wolf',
                        'shelves': 'shelf',
                        'loaves': 'loaf',
                        'thieves': 'thief',
                        'calves': 'calf',
                        'elves': 'elf',
                        'halves': 'half',
                        'scarves': 'scarf',
                        'wharves': 'wharf',
                        'analyses': 'analysis',
                        'bases': 'basis',
                        'crises': 'crisis',
                        'diagnoses': 'diagnosis',
                        'hypotheses': 'hypothesis',
                        'parentheses': 'parenthesis',
                        'phenomena': 'phenomenon',
                        'criteria': 'criterion',
                        'data': 'datum',
                        'media': 'medium',
                        'memoranda': 'memorandum',
                        'strata': 'stratum',
                        'symposia': 'symposium',
                        'theses': 'thesis',
                        'indices': 'index',
                        'matrices': 'matrix',
                        'vertices': 'vertex',
                        'appendices': 'appendix',
                        'formulae': 'formula',
                        'fungi': 'fungus',
                        'nuclei': 'nucleus',
                        'stimuli': 'stimulus',
                        'syllabi': 'syllabus',
                        'termini': 'terminus',
                        'viri': 'virus',
                        'alumni': 'alumnus',
                        'cacti': 'cactus',
                        'foci': 'focus',
                        'hippopotami': 'hippopotamus',
                        'octopi': 'octopus',
                        'platypi': 'platypus',
                        'stimuli': 'stimulus',
                        'syllabi': 'syllabus',
                        'termini': 'terminus',
                        'viri': 'virus'
                    };

                    // Check irregular plurals first
                    if (irregulars[word]) {
                        return irregulars[word];
                    }

                    // Keep words ending with 'ss' as is
                    if (word.endsWith('ss')) {
                        return word;
                    }
            
                    // Handle common plural endings
                    if (word.endsWith('ies')) {
                        return word.slice(0, -3) + 'y';
                    }
                    if (word.endsWith('es')) {
                        // Handle words ending in 'es' (e.g., 'boxes', 'watches')
                        const base = word.slice(0, -2);
                        if (base.endsWith('s') || base.endsWith('x') || base.endsWith('z') || 
                            base.endsWith('ch') || base.endsWith('sh')) {
                            return base;
                        }
                    }

                    return word;
                }

                // Function to convert verb to base form
                function toBaseForm(word) {
                    // Common irregular verbs
                    const irregulars = {
                        'is': 'be',
                        'are': 'be',
                        'was': 'be',
                        'were': 'be',
                        'been': 'be',
                        'being': 'be',
                        'has': 'have',
                        'had': 'have',
                        'having': 'have',
                        'does': 'do',
                        'did': 'do',
                        'doing': 'do',
                        'goes': 'go',
                        'went': 'go',
                        'gone': 'go',
                        'going': 'go',
                        'makes': 'make',
                        'made': 'make',
                        'making': 'make',
                        'takes': 'take',
                        'took': 'take',
                        'taken': 'take',
                        'taking': 'take',
                        'comes': 'come',
                        'came': 'come',
                        'coming': 'come',
                        'sees': 'see',
                        'saw': 'see',
                        'seen': 'see',
                        'seeing': 'see',
                        'knows': 'know',
                        'knew': 'know',
                        'known': 'know',
                        'knowing': 'know',
                        'gets': 'get',
                        'got': 'get',
                        'gotten': 'get',
                        'getting': 'get',
                        'gives': 'give',
                        'gave': 'give',
                        'given': 'give',
                        'giving': 'give',
                        'finds': 'find',
                        'found': 'find',
                        'finding': 'find',
                        'thinks': 'think',
                        'thought': 'think',
                        'thinking': 'think',
                        'tells': 'tell',
                        'told': 'tell',
                        'telling': 'tell',
                        'asks': 'ask',
                        'asked': 'ask',
                        'asking': 'ask',
                        'works': 'work',
                        'worked': 'work',
                        'working': 'work',
                        'seems': 'seem',
                        'seemed': 'seem',
                        'seeming': 'seem',
                        'feels': 'feel',
                        'felt': 'feel',
                        'feeling': 'feel',
                        'tries': 'try',
                        'tried': 'try',
                        'trying': 'try',
                        'leaves': 'leave',
                        'left': 'leave',
                        'leaving': 'leave',
                        'calls': 'call',
                        'called': 'call',
                        'calling': 'call',
                        'asks': 'ask',
                        'asked': 'ask',
                        'asking': 'ask',
                        'needs': 'need',
                        'needed': 'need',
                        'needing': 'need',
                        'wants': 'want',
                        'wanted': 'want',
                        'wanting': 'want',
                        'shows': 'show',
                        'showed': 'show',
                        'shown': 'show',
                        'showing': 'show',
                        'provides': 'provide',
                        'provided': 'provide',
                        'providing': 'provide',
                        'includes': 'include',
                        'included': 'include',
                        'including': 'include',
                        'considers': 'consider',
                        'considered': 'consider',
                        'considering': 'consider',
                        'appears': 'appear',
                        'appeared': 'appear',
                        'appearing': 'appear',
                        'requires': 'require',
                        'required': 'require',
                        'requiring': 'require',
                        'allows': 'allow',
                        'allowed': 'allow',
                        'allowing': 'allow',
                        'suggests': 'suggest',
                        'suggested': 'suggest',
                        'suggesting': 'suggest',
                        'indicates': 'indicate',
                        'indicated': 'indicate',
                        'indicating': 'indicate',
                        'demonstrates': 'demonstrate',
                        'demonstrated': 'demonstrate',
                        'demonstrating': 'demonstrate',
                        'represents': 'represent',
                        'represented': 'represent',
                        'representing': 'represent',
                        'develops': 'develop',
                        'developed': 'develop',
                        'developing': 'develop',
                        'occurs': 'occur',
                        'occurred': 'occur',
                        'occurring': 'occur',
                        'exists': 'exist',
                        'existed': 'exist',
                        'existing': 'exist',
                        'involves': 'involve',
                        'involved': 'involve',
                        'involving': 'involve',
                        'results': 'result',
                        'resulted': 'result',
                        'resulting': 'result',
                        'follows': 'follow',
                        'followed': 'follow',
                        'following': 'follow',
                        'changes': 'change',
                        'changed': 'change',
                        'changing': 'change',
                        'continues': 'continue',
                        'continued': 'continue',
                        'continuing': 'continue',
                        'begins': 'begin',
                        'began': 'begin',
                        'begun': 'begin',
                        'beginning': 'begin',
                        'becomes': 'become',
                        'became': 'become',
                        'becoming': 'become',
                        'contains': 'contain',
                        'contained': 'contain',
                        'containing': 'contain',
                        'means': 'mean',
                        'meant': 'mean',
                        'meaning': 'mean',
                        'reduces': 'reduce',
                        'reduced': 'reduce',
                        'reducing': 'reduce',
                        'increases': 'increase',
                        'increased': 'increase',
                        'increasing': 'increase',
                        'produces': 'produce',
                        'produced': 'produce',
                        'producing': 'produce',
                        'determines': 'determine',
                        'determined': 'determine',
                        'determining': 'determine',
                        'forms': 'form',
                        'formed': 'form',
                        'forming': 'form',
                        'creates': 'create',
                        'created': 'create',
                        'creating': 'create',
                        'causes': 'cause',
                        'caused': 'cause',
                        'causing': 'cause',
                        'serves': 'serve',
                        'served': 'serve',
                        'serving': 'serve',
                        'moves': 'move',
                        'moved': 'move',
                        'moving': 'move',
                        'uses': 'use',
                        'used': 'use',
                        'using': 'use',
                        'applies': 'apply',
                        'applied': 'apply',
                        'applying': 'apply'
                    };

                    // Check irregular verbs first
                    if (irregulars[word]) {
                        return irregulars[word];
                    }

                    // Keep words ending with 'ss' as is
                    if (word.endsWith('ss')) {
                        return word;
                    }

                    // Handle regular verb endings
                    if (word.endsWith('ing')) {
                        // Keep hyphenated compound words unchanged
                        if (word.includes('-')) {
                            return word;
                        }
                        // Handle present participle
                        const base = word.slice(0, -3);
                        if (base.endsWith('i')) {
                            return base.slice(0, -1) + 'y';
                        }
                        if (base.endsWith('e')) {
                            return base.slice(0, -1);
                        }
                        // Add back 'e' for verbs that should end with 'e'
                        if (!base.endsWith('e') && !base.endsWith('i')) {
                            return base + 'e';
                        }
                        return base;
                    }
                    if (word.endsWith('ed')) {
                        // Handle past tense and past participle
                        const base = word.slice(0, -2);
                        if (base.endsWith('i')) {
                            return base.slice(0, -1) + 'y';
                        }
                        if (base.endsWith('e')) {
                            return base;
                        }
                        // Add back 'e' for verbs that should end with 'e'
                        if (!base.endsWith('e') && !base.endsWith('i')) {
                            return base + 'e';
                        }
                        return base;
                    }
                    if (word.endsWith('s')) {
                        // Handle third person singular
                        const base = word.slice(0, -1);
                        if (base.endsWith('i')) {
                            return base.slice(0, -1) + 'y';
                        }
                        if (base.endsWith('u')) { // e.g., continuous.
                            return base+ 's';
                        }
                        return base;
                    }

                    return word;
                }

                const wordCount = {};
                words.forEach(word => {
                    const singular = toSingular(word);
                    const base = toBaseForm(singular);
                    wordCount[base] = (wordCount[base] || 0) + 1;
                });

                // Convert to array of objects for d3-cloud
                const wordData = Object.entries(wordCount)
                    .sort((a, b) => b[1] - a[1]) // Sort by frequency
                    .filter(([_, count]) => count > 2) // Only include words that appear more than twice
                    .slice(0, 100) // Take top 100 words
                    .map(([text, size]) => {
                        // Calculate relative size (percentage of total words)
                        const relativeSize = size / words.length;
                        return {
                            text,
                            size: Math.pow(relativeSize * 200, 1.2) * 5 // Scale relative size
                        };
                    });

                // Normalize word sizes to have consistent maximum size
                const maxSize = 100; // Maximum font size in pixels
                const minSize = 20;  // Minimum font size in pixels
                const maxRelativeSize = Math.max(...wordData.map(d => d.size));
                const minRelativeSize = Math.min(...wordData.map(d => d.size));
                
                wordData.forEach(d => {
                    // Linear interpolation between min and max sizes
                    d.size = minSize + (maxSize - minSize) * 
                        ((d.size - minRelativeSize) / (maxRelativeSize - minRelativeSize));
                });

                // Get container dimensions
                const width = wordcloudContainer.node().offsetWidth;
                const height = 400;

                // Create new layout
                if (currentLayout) {
                    currentLayout.stop();
                }

                currentLayout = d3.layout.cloud()
                    .size([width, height])
                    .words(wordData)
                    .padding(2)  // Reduced padding between words
                    .rotate(() => ~~(Math.random() * 2) * 90)
                    .font('Arial')
                    .fontSize(d => d.size)
                    .spiral('archimedean')  // Use archimedean spiral for tighter packing
                    .on('end', draw);

                currentLayout.start();

                function draw(words) {
                    // Clear previous word cloud
                    wordcloudContainer.selectAll('svg').remove();

                    const svg = wordcloudContainer
                        .append('svg')
                        .attr('width', width)
                        .attr('height', height);

                    // Add words with transition
                    const wordElements = svg.append('g')
                        .attr('transform', `translate(${width/2},${height/2})`)
                        .selectAll('text')
                        .data(words)
                        .enter()
                        .append('text')
                        .style('font-size', d => `${d.size}px`)
                        .style('font-family', 'Arial')
                        .style('fill', () => d3.schemeCategory10[~~(Math.random() * 10)])
                        .attr('text-anchor', 'middle')
                        .attr('transform', d => `translate(${d.x},${d.y}) rotate(${d.rotate})`)
                        .text(d => d.text)
                        .classed('word', true)
                        .style('opacity', 0)
                        .transition()
                        .duration(500)
                        .style('opacity', 1);

                    // Hide loading indicator after transition
                    setTimeout(() => {
                        loadingDiv.classed('active', false);
                    }, 500);
                }
            })
            .catch(error => {
                console.error('Error processing papers:', error);
                loadingDiv.classed('active', false);
            });
    }

    function applyFilters() {
        const selectedYears = Array.from(yearFilter.selectedOptions).map(option => option.value);
        const selectedJournals = Array.from(journalFilter.selectedOptions).map(option => option.value);
        const selectedTypes = Array.from(typeFilter.selectedOptions).map(option => option.value);

        paperItems.forEach(item => {
            const year = item.dataset.year;
            const journal = item.dataset.journal;
            const type = item.dataset.type;

            const yearMatch = selectedYears.length === 0 || selectedYears.includes(year);
            const journalMatch = selectedJournals.length === 0 || selectedJournals.includes(journal);
            const typeMatch = selectedTypes.length === 0 || selectedTypes.includes(type);

            if (yearMatch && journalMatch && typeMatch) {
                item.classList.remove('hidden');
            } else {
                item.classList.add('hidden');
            }
        });

        updatePaperCount();
        updateNumbering();
        updateFilterCriteria();
        updateFilterGroups();
        generateWordCloud(); // Generate word cloud immediately after filtering
    }

    // Add event listeners for filters
    yearFilter.addEventListener('change', applyFilters);
    journalFilter.addEventListener('change', applyFilters);
    typeFilter.addEventListener('change', applyFilters);

    resetButton.addEventListener('click', function() {
        yearFilter.selectedIndex = -1;
        journalFilter.selectedIndex = -1;
        typeFilter.selectedIndex = -1;
        applyFilters();
    });

    // Initial updates
    updateNumbering();
    updateFilterCriteria();
    updateFilterGroups();
    generateWordCloud(); // Generate initial word cloud

    function generateTimeline() {
        // Get visible papers
        const visiblePapers = document.querySelectorAll('.paper-item:not(.hidden)');
        
        // Group papers by year and type
        const papersByYearAndType = {};
        visiblePapers.forEach(paper => {
            const year = paper.dataset.year;
            const type = paper.dataset.type || 'substantive'; // Default to substantive if not specified
            
            if (!papersByYearAndType[year]) {
                papersByYearAndType[year] = {
                    statistical: [],
                    substantive: []
                };
            }
            papersByYearAndType[year][type].push({
                title: paper.querySelector('.paper-title').textContent,
                journal: paper.dataset.journal || '',
                link: paper.querySelector('.paper-title a').href
            });
        });

        // Convert to array and sort by year
        const timelineData = Object.entries(papersByYearAndType)
            .map(([year, data]) => ({
                year: year === 'submitted' ? 'submitted' : parseInt(year),
                statistical: data.statistical.length,
                substantive: data.substantive.length,
                papers: {
                    statistical: data.statistical,
                    substantive: data.substantive
                }
            }))
            .sort((a, b) => {
                if (a.year === 'submitted') return 1;
                if (b.year === 'submitted') return -1;
                return a.year - b.year;
            });

        // Clear previous timeline
        d3.select('#timeline').selectAll('*').remove();

        // Set up dimensions
        const margin = {top: 10, right: 20, bottom: 60, left: 40};
        const width = document.getElementById('timeline').offsetWidth - margin.left - margin.right;
        const height = 150 - margin.top - margin.bottom;  // Increased height

        // Create SVG
        const svg = d3.select('#timeline')
            .append('svg')
            .attr('width', width + margin.left + margin.right)
            .attr('height', height + margin.top + margin.bottom)
            .append('g')
            .attr('transform', `translate(${margin.left},${margin.top})`);

        // Create scales
        const x = d3.scaleBand()
            .domain(timelineData.map(d => d.year))
            .range([0, width])
            .padding(0.1);

        const y = d3.scaleLinear()
            .domain([0, d3.max(timelineData, d => d.statistical + d.substantive)])
            .range([height, 0])
            .nice();

        // Add X axis
        svg.append('g')
            .attr('class', 'timeline-axis')
            .attr('transform', `translate(0,${height})`)
            .call(d3.axisBottom(x))
            .selectAll('text')
            .style('text-anchor', 'end')
            .attr('dx', '-.8em')
            .attr('dy', '.15em')
            .attr('transform', 'rotate(-45)')
            .style('font-size', '10px');

        // Add Y axis
        svg.append('g')
            .attr('class', 'timeline-axis')
            .call(d3.axisLeft(y).ticks(3))
            .selectAll('text')
            .style('font-size', '10px');

        // Add Y axis label
        svg.append('text')
            .attr('transform', 'rotate(-90)')
            .attr('y', 0 - margin.left)
            .attr('x', 0 - (height / 2))
            .attr('dy', '1em')
            .style('text-anchor', 'middle')
            .style('font-size', '10px')
            .text('Number of Publications');

        // Create tooltip
        const tooltip = d3.select('body')
            .append('div')
            .attr('class', 'timeline-tooltip')
            .style('opacity', 0);

        // Create color scale for types
        const color = d3.scaleOrdinal()
            .domain(['statistical', 'substantive'])
            .range(['#1f77b4', '#ff7f0e']);

        // Add stacked bars
        const types = ['statistical', 'substantive'];
        
        types.forEach((type, i) => {
            svg.selectAll(`.timeline-bar-${type}`)
                .data(timelineData)
                .enter()
                .append('rect')
                .attr('class', `timeline-bar timeline-bar-${type}`)
                .attr('x', d => x(d.year))
                .attr('y', d => y(d[type] + (i === 0 ? 0 : d.statistical)))
                .attr('width', x.bandwidth())
                .attr('height', d => height - y(d[type]))
                .style('fill', color(type))
                .on('mouseover', function(event, d) {
                    tooltip.transition()
                        .duration(200)
                        .style('opacity', .9);
                    
                    const papersList = d.papers[type].map(paper => 
                        `<li><a href="${paper.link}">${paper.title}</a>${paper.journal ? ` - ${paper.journal}` : ''}</li>`
                    ).join('');
                    
                    tooltip.html(`
                        <h4>${d.year} - ${type.charAt(0).toUpperCase() + type.slice(1)} (${d[type]} publication${d[type] > 1 ? 's' : ''})</h4>
                        <ul>${papersList}</ul>
                    `)
                        .style('left', (event.pageX + 10) + 'px')
                        .style('top', (event.pageY - 28) + 'px');
                })
                .on('mouseout', function() {
                    tooltip.transition()
                        .duration(500)
                        .style('opacity', 0);
                });
        });

        // Add legend
        const legend = svg.append('g')
            .attr('class', 'legend')
            .attr('transform', `translate(${width/2 - 100}, ${height + 45})`);  // Moved legend down

        types.forEach((type, i) => {
            const legendRow = legend.append('g')
                .attr('transform', `translate(${i * 120}, 0)`);  // Space items horizontally

            legendRow.append('rect')
                .attr('width', 10)
                .attr('height', 10)
                .style('fill', color(type));

            legendRow.append('text')
                .attr('x', 15)
                .attr('y', 10)
                .style('font-size', '10px')
                .text(type.charAt(0).toUpperCase() + type.slice(1));
        });

        // Add total value labels on top of bars
        svg.selectAll('.value-label')
            .data(timelineData)
            .enter()
            .append('text')
            .attr('class', 'value-label')
            .attr('x', d => x(d.year) + x.bandwidth() / 2)
            .attr('y', d => y(d.statistical + d.substantive) - 8)  // Increased spacing from bar
            .attr('text-anchor', 'middle')
            .style('font-size', '10px')
            .style('fill', '#666')
            .style('font-weight', 'bold')  // Make numbers more visible
            .style('pointer-events', 'none')  // Prevent tooltip interference
            .text(d => d.statistical + d.substantive);

        // Adjust the height of the SVG to accommodate the labels
        svg.attr('transform', `translate(${margin.left},${margin.top + 5})`);  // Add some top padding
    }

    // Modify the applyFilters function to include timeline generation
    const originalApplyFilters = applyFilters;
    applyFilters = function() {
        originalApplyFilters();
        generateTimeline(); // Generate timeline after filtering
    };

    // Generate initial timeline
    generateTimeline();
});
</script>
